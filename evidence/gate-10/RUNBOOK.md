# Dusk Library Runbook
## Gate 10 - Incident Management

### Incident 1: Discord API Gateway Unreachable / 5xx Loops
**Trigger:** Your bot logs are filled with `HTTP 502 Bad Gateway` or `HTTP 500 Internal Server Error` escaping from `await Client.request(...)`.
**Severity:** Critical
**Resolution:**
1. Check the official [Discord Status](https://discordstatus.com/).
2. The library `Dusk` has native Cro::HTTP retries. If the error escapes, it means the API has been entirely offline for repeated checks.
3. Stop the bot supervisor (`systemctl stop bot` or `docker stop`).
4. Wait for Discord to announce recovery before rebooting, as aggressive hammering while they are down might trigger permanent Token bans.

### Incident 2: Token Revoked / 401 Unauthorized
**Trigger:** `HTTP Error: 401` crashes the application.
**Severity:** Critical
**Resolution:**
1. The token inside `.env` (`DISCORD_BOT_TOKEN`) has been leaked or forcefully regenerated by the owner on the Discord Application Dashboard.
2. Go to `https://discord.com/developers/applications`, select the Bot, and click "Reset Token".
3. Update `.env` with the new Token.
4. Restart the bot.

### Incident 3: Type Check Failures / Model Deserialization Crashing
**Trigger:** `Type Check failed in binding to...`
**Severity:** High
**Resolution:**
1. Discord has likely released an undocumented v10 API change (e.g., changing a property from `Str` to `Int` or adding a new constraint).
2. Look at the stack trace to determine which `Dusk::Model::*` object caused the crash.
3. Fork `Dusk`, adjust the `.rakumod` file by relaxing the Type Constraint (`Any`) or applying an explicit type coercion logic (`.Int`).
4. Re-run `prove6 -l t/` to verify it fixes the issue.
5. Deploy the hotfix.

---

## Consumer Troubleshooting Guide

### Issue: `zef install Dusk` fails

**Cause:** Integration tests (`t/05-integration.t`) compile `Cro::HTTP::Client` at `use` time. From a staging directory, the `.env` file is absent.
**Fix:** Install with `zef install --force-test Dusk` or set `DISCORD_BOT_TOKEN` in your environment before installing.

### Issue: `Could not find Dusk::Error` at runtime

**Cause:** You are using a version older than 0.1.2 or `META6.json` does not list `Dusk::Error`.
**Fix:** Update to latest: `zef upgrade Dusk`.

### Issue: Methods return `Hash` instead of typed Model objects

**Cause:** Only `/channels/:id` routes auto-deserialize to `Dusk::Model::Channel`. All other endpoints return raw `Hash` from the JSON response.
**Fix:** Access fields via hash keys: `$result<id>`, `$result<username>`, etc. Typed deserialization for all endpoints is planned for v0.2.x.

### Issue: Bot token not accepted / `Unauthorized` error

**Cause:** Token is invalid, expired, or copied incorrectly.
**Fix:**
1. Verify token at `https://discord.com/developers/applications`
2. Ensure you use the **Bot** token, not the OAuth2 client secret
3. Check for leading/trailing whitespace in your `.env` file

### Compatibility Matrix

| Dependency | Minimum Version | Tested With |
|-----------|----------------|-------------|
| Raku | v6.d | 2024.09 |
| `Cro::HTTP::Client` | any | 0.8.9 |
| `JSON::Fast` | any | 0.19 |
